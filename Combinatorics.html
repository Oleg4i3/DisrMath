<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Візуалізатор Комбінаторики </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f3f4f6;
            --card: #ffffff;
            --text: #1f2937;
            --accent-source: #e0e7ff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 1000px;
            width: 100%;
            background: var(--card);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        h1 { text-align: center; color: var(--primary); margin-bottom: 20px; }

        /* Tabs */
        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
            justify-content: center;
        }

        .tab-btn {
            padding: 8px 16px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            color: #6b7280;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .tab-btn:hover { background-color: #e0e7ff; color: var(--primary); }
        .tab-btn.active { background-color: var(--primary); color: white; }

        /* Info Areas */
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        @media(max-width: 768px) { .info-grid { grid-template-columns: 1fr; } }

        .formula-box, .source-box {
            background: #fffbeb;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            border-radius: 4px;
        }
        
        .source-box {
            background: var(--accent-source);
            border-left: 4px solid var(--primary);
        }

        .math-display { font-size: 1.1rem; margin: 10px 0; overflow-x: auto; }
        .sub-math { color: var(--primary); font-weight: bold; border-top: 1px solid #ddd; padding-top: 10px; margin-top: 10px;}

        /* Controls */
        .controls {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
        }

        .input-group { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .input-group label { font-weight: bold; min-width: 200px;}
        
        input[type="number"] {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            width: 70px;
            font-size: 1rem;
        }

        /* Visual Elements */
        .ball, .paint-bucket, .empty-slot {
            width: 24px;
            height: 24px;
            display: inline-block;
            margin: 2px;
            vertical-align: middle;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .ball {
            border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.2);
            background-image: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.4), transparent);
        }

        .paint-bucket {
            border-radius: 4px; /* Square for paint */
            border: 2px solid rgba(0,0,0,0.3);
        }

        .empty-slot {
            border-radius: 50%;
            border: 2px dashed #9ca3af;
            background: white;
        }

        .source-viz-container {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .viz-group {
            display: flex;
            align-items: center;
            background: white;
            padding: 5px 10px;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
        }
        .viz-label { font-size: 0.8rem; color: #64748b; margin-right: 8px; text-transform: uppercase; font-weight: bold;}

        /* Multiset UI */
        .color-picker-area { display: flex; gap: 10px; flex-wrap: wrap; }
        .color-slot {
            display: flex;
            align-items: center;
            gap: 5px;
            background: white;
            padding: 5px 10px;
            border-radius: 20px;
            border: 1px solid #ddd;
        }

        button.action-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1rem;
            width: 100%;
            font-weight: bold;
            margin-top: 10px;
            transition: background 0.2s;
        }
        button.action-btn:hover { background-color: #4338ca; }

        /* Results */
        .stats { font-size: 1.2rem; margin-bottom: 15px; font-weight: bold; text-align: center; }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #fafafa;
        }

        .result-item {
            display: flex;
            justify-content: center;
            gap: 4px;
            background: white;
            padding: 8px;
            border-radius: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .warning { color: #dc2626; font-size: 0.9rem; margin-top: 5px; text-align: center;}
    </style>
</head>
<body>

<div class="container">
    <h1>Комбінаторика</h1>

    <div class="tabs" id="tabs">
        <button class="tab-btn active" onclick="setMode('perm')">Перестановки (Pₙ)</button>
        <button class="tab-btn" onclick="setMode('perm_rep')">Перестановки з повтор. (Pₙ(k,m,...))</button>
        <button class="tab-btn" onclick="setMode('arr')">Розміщення (Aₙᵏ)</button>
        <button class="tab-btn" onclick="setMode('arr_rep')">Розміщення з повтор. (Ãₙᵏ)</button>
        <button class="tab-btn" onclick="setMode('comb')">Комбінації (Cₙᵏ)</button>
        <button class="tab-btn" onclick="setMode('comb_rep')">Комбінації з повтор. (C̃ₙᵏ)</button>
    </div>

    <div class="info-grid">
        <div class="formula-box">
            <strong>Формула:</strong>
            <div id="formula-display" class="math-display">$$ P_n = n! $$</div>
            <div id="substitution-display" class="sub-math"></div>
        </div>
        <div class="source-box">
            <strong>Що маємо (Вхідні дані):</strong>
            <div id="source-visualization" class="source-viz-container"></div>
        </div>
    </div>

    <div class="controls">
        <div id="dynamic-inputs"></div>
        <div id="limit-warning" class="warning"></div>
        <button class="action-btn" onclick="calculate()">▶ Згенерувати та порахувати</button>
    </div>

    <div class="stats" id="stats-output">Результат: 0 варіантів</div>
    <div class="results-grid" id="visual-output"></div>
</div>

<script>
    // Config
    let currentMode = 'perm';
    const COLORS = ['#ef4444', '#3b82f6', '#22c55e', '#eab308', '#a855f7', '#ec4899', '#64748b', '#06b6d4', '#f97316'];
    
    // State for multiset inputs (color counts)
    let multisetState = [
        { color: COLORS[1], count: 2 }, // Blue
        { color: COLORS[2], count: 1 }  // Green
    ];

    // --- INIT ---
    function init() {
        updateUI();
    }

    // --- MODE SWITCHING ---
    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        updateUI();
        // Clear results
        document.getElementById('visual-output').innerHTML = '<div style="padding:20px; text-align:center; color:#999; width:100%">Натисніть кнопку для результату</div>';
        document.getElementById('stats-output').innerText = '';
    }

    // --- UI RENDERING ---
    function updateUI() {
        const container = document.getElementById('dynamic-inputs');
        const formulaDisplay = document.getElementById('formula-display');
        let html = '';
        let formula = '';

        // 1. Generate Controls
        switch(currentMode) {
            case 'perm':
                html = getInputHtml('Кількість елементів (N):', 'inp-n', 3, 1, 7);
                formula = '$$ P_n = n! $$';
                break;
            case 'perm_rep':
                html = getMultisetUI('Склад набору (кульки):');
                formula = '$$ P_n(n_1, n_2...) = \\frac{n!}{n_1!n_2!...} $$';
                break;
            case 'arr':
                html = getInputHtml('Всього доступно (N):', 'inp-n', 4, 1, 8) + 
                       getInputHtml('Вибрати місць (K):', 'inp-k', 2, 1, 8);
                formula = '$$ A_n^k = \\frac{n!}{(n-k)!} $$';
                break;
            case 'arr_rep':
                html = getInputHtml('Кількість кольорів (N):', 'inp-n', 3, 1, 6) + 
                       getInputHtml('Кількість кульок/місць (K):', 'inp-k', 3, 1, 6);
                formula = '$$ \\tilde{A}_n^k = n^k $$';
                break;
            case 'comb':
                html = getInputHtml('Всього доступно (N):', 'inp-n', 5, 1, 10) + 
                       getInputHtml('Вибрати (K):', 'inp-k', 3, 1, 10);
                formula = '$$ C_n^k = \\frac{n!}{k!(n-k)!} $$';
                break;
            case 'comb_rep':
                html = getInputHtml('Кількість кольорів (N):', 'inp-n', 3, 1, 6) + 
                       getInputHtml('Кількість кульок у наборі (K):', 'inp-k', 4, 1, 8);
                formula = '$$ \\tilde{C}_n^k = C_{n+k-1}^k = \\frac{(n+k-1)!}{k!(n-1)!} $$';
                break;
        }

        container.innerHTML = html;
        formulaDisplay.innerHTML = formula;
        
        // Re-process MathJax
        if(window.MathJax) MathJax.Hub.Queue(["Typeset", MathJax.Hub, formulaDisplay]);

        // 2. Trigger Source Visualization Preview immediately
        updatePreview();
    }

    function getInputHtml(label, id, val, min, max) {
        return `
            <div class="input-group">
                <label>${label}</label>
                <input type="number" id="${id}" value="${val}" min="${min}" max="${max}" onchange="updatePreview()">
            </div>`;
    }

    function getMultisetUI(label) {
        let listHtml = multisetState.map((item, idx) => `
            <div class="color-slot">
                <div class="ball" style="background:${item.color}"></div>
                <input type="number" min="1" max="5" value="${item.count}" onchange="updateMultisetCount(${idx}, this.value)">
                <button onclick="removeMultisetItem(${idx})" style="border:none;background:none;cursor:pointer;color:red;font-weight:bold;font-size:1.2em">&times;</button>
            </div>
        `).join('');

        return `
            <div class="input-group">
                <label>${label}</label>
                <div class="color-picker-area" id="multiset-list">
                    ${listHtml}
                    <button onclick="addMultisetItem()" style="border:1px dashed #6366f1; color:#4f46e5; background:white; padding:5px 15px; border-radius:20px; cursor:pointer; font-weight:bold">+ Додати колір</button>
                </div>
            </div>
        `;
    }

    // --- LIVE PREVIEW UPDATES ---
    function updatePreview() {
        updateSourceVisuals();
        updateSubstitutionMath();
    }

    // Fix 3 & 4: Visualize Source N and K
    function updateSourceVisuals() {
        const container = document.getElementById('source-visualization');
        container.innerHTML = '';

        let n = 0, k = 0;
        // Get values safely
        const nEl = document.getElementById('inp-n');
        const kEl = document.getElementById('inp-k');
        if(nEl) n = parseInt(nEl.value);
        if(kEl) k = parseInt(kEl.value);

        // Helper to create visualization groups
        const createGroup = (label, itemsHtml) => {
            return `<div class="viz-group"><span class="viz-label">${label}:</span> ${itemsHtml}</div>`;
        };

        if (['perm', 'arr', 'comb'].includes(currentMode)) {
            // Standard set: Just distinct balls
            let ballsHtml = '';
            for(let i=0; i<n; i++) {
                ballsHtml += `<div class="ball" style="background-color: ${COLORS[i] || '#000'}"></div>`;
            }
            container.innerHTML = createGroup(`Множина N (${n})`, ballsHtml);
            
            if(currentMode !== 'perm') {
                 // Visualize slots for selection? Not strictly necessary but helpful context
            }
        }
        else if (['arr_rep', 'comb_rep'].includes(currentMode)) {
            // Paints and Empty Balls
            let paintsHtml = '';
            for(let i=0; i<n; i++) {
                paintsHtml += `<div class="paint-bucket" style="background-color: ${COLORS[i] || '#000'}"></div>`;
            }
            container.innerHTML += createGroup(`Фарби N (${n})`, paintsHtml);

            let slotsHtml = '';
            for(let i=0; i<k; i++) {
                slotsHtml += `<div class="empty-slot"></div>`;
            }
            container.innerHTML += createGroup(`Кульки K (${k})`, slotsHtml);
        }
        else if (currentMode === 'perm_rep') {
            // Multiset contents
            let itemsHtml = '';
            let total = 0;
            multisetState.forEach(item => {
                for(let i=0; i<item.count; i++) {
                    itemsHtml += `<div class="ball" style="background-color: ${item.color}"></div>`;
                }
                total += item.count;
            });
            container.innerHTML = createGroup(`Мультимножина (Всього ${total})`, itemsHtml);
        }
    }

    // Fix 2: Math Substitution
    function updateSubstitutionMath() {
        const display = document.getElementById('substitution-display');
        let latex = '';

        let n = 0, k = 0;
        const nEl = document.getElementById('inp-n');
        const kEl = document.getElementById('inp-k');
        if(nEl) n = parseInt(nEl.value);
        if(kEl) k = parseInt(kEl.value);

        const fact = (num) => {
            if (num < 0) return 0;
            let r = 1; for(let i=2; i<=num; i++) r*=i; 
            return r;
        };

        if (currentMode === 'perm') {
            let val = fact(n);
            latex = `$$ P_{${n}} = ${n}! = ${val} $$`;
        }
        else if (currentMode === 'arr') {
            if(k > n) latex = `$$ k > n \\rightarrow 0 $$`;
            else {
                let val = fact(n)/fact(n-k);
                latex = `$$ A_{${n}}^{${k}} = \\frac{${n}!}{(${n}-${k})!} = \\frac{${n}!}{${n-k}!} = ${val} $$`;
            }
        }
        else if (currentMode === 'comb') {
            if(k > n) latex = `$$ k > n \\rightarrow 0 $$`;
            else {
                let val = Math.round(fact(n)/(fact(k)*fact(n-k)));
                latex = `$$ C_{${n}}^{${k}} = \\frac{${n}!}{${k}!(${n}-${k})!} = ${val} $$`;
            }
        }
        else if (currentMode === 'arr_rep') {
            let val = Math.pow(n, k);
            latex = `$$ \\tilde{A}_{${n}}^{${k}} = ${n}^{${k}} = ${val} $$`;
        }
        else if (currentMode === 'comb_rep') {
            let top = n + k - 1;
            let val = Math.round(fact(top) / (fact(k) * fact(top-k)));
            latex = `$$ \\tilde{C}_{${n}}^{${k}} = C_{${n}+${k}-1}^{${k}} = C_{${top}}^{${k}} = \\frac{${top}!}{${k}!${n-1}!} = ${val} $$`;
        }
        else if (currentMode === 'perm_rep') {
            let total = 0;
            let denoms = [];
            let denomVal = 1;
            multisetState.forEach(i => {
                total += i.count;
                denoms.push(`${i.count}!`);
                denomVal *= fact(i.count);
            });
            let numVal = fact(total);
            let final = Math.round(numVal / denomVal);
            
            latex = `$$ P(${multisetState.map(i=>i.count).join(',')}) = \\frac{${total}!}{${denoms.join('\\cdot')}} = ${final} $$`;
        }

        display.innerHTML = latex;
        if(window.MathJax) MathJax.Hub.Queue(["Typeset", MathJax.Hub, display]);
    }

    // --- STATE HANDLERS ---
    // Fix 1: Add Color Logic (Find unused)
    window.addMultisetItem = function() {
        // Find colors currently used
        const usedColors = multisetState.map(m => m.color);
        // Find first color in palette NOT in usedColors
        const availableColor = COLORS.find(c => !usedColors.includes(c));

        if(availableColor) {
            multisetState.push({ color: availableColor, count: 1 });
            updateUI();
        } else {
            alert("Всі доступні кольори вже використані!");
        }
    }
    window.removeMultisetItem = function(idx) {
        multisetState.splice(idx, 1);
        updateUI();
    }
    window.updateMultisetCount = function(idx, val) {
        multisetState[idx].count = parseInt(val);
        updatePreview(); // Update viz immediately
    }

    // --- CALCULATION ENGINE ---
    function calculate() {
        const output = document.getElementById('visual-output');
        const stats = document.getElementById('stats-output');
        const warning = document.getElementById('limit-warning');
        
        output.innerHTML = '';
        warning.innerText = '';
        stats.innerText = 'Рахуємо...';

        // Give UI a moment to render loading state
        setTimeout(() => {
            let results = [];
            let limit = 3000; // Rendering limit

            try {
                if (currentMode === 'perm') {
                    const n = parseInt(document.getElementById('inp-n').value);
                    results = getPermutations(COLORS.slice(0, n));
                }
                else if (currentMode === 'arr') {
                    const n = parseInt(document.getElementById('inp-n').value);
                    const k = parseInt(document.getElementById('inp-k').value);
                    if(k > n) throw new Error("K > N неможливо без повторень");
                    results = getArrangements(COLORS.slice(0, n), k);
                }
                else if (currentMode === 'comb') {
                    const n = parseInt(document.getElementById('inp-n').value);
                    const k = parseInt(document.getElementById('inp-k').value);
                    if(k > n) throw new Error("K > N неможливо без повторень");
                    results = getCombinations(COLORS.slice(0, n), k);
                }
                else if (currentMode === 'arr_rep') {
                    const n = parseInt(document.getElementById('inp-n').value);
                    const k = parseInt(document.getElementById('inp-k').value);
                    results = getArrangementsRep(COLORS.slice(0, n), k);
                }
                else if (currentMode === 'comb_rep') {
                    const n = parseInt(document.getElementById('inp-n').value);
                    const k = parseInt(document.getElementById('inp-k').value);
                    results = getCombinationsRep(COLORS.slice(0, n), k);
                }
                else if (currentMode === 'perm_rep') {
                    let pool = [];
                    multisetState.forEach(item => {
                        for(let i=0; i<item.count; i++) pool.push(item.color);
                    });
                    if(pool.length > 9) { warning.innerText = "Увага: дуже велика кількість елементів!"; }
                    results = getUniquePermutations(pool);
                }

                // Render
                stats.innerText = `Всього варіантів: ${results.length}`;
                
                if(results.length > limit) {
                    warning.innerText = `Показано перші ${limit} з ${results.length}. Решта прихована для швидкодії.`;
                    results = results.slice(0, limit);
                }

                // Fragment for performance
                const fragment = document.createDocumentFragment();
                results.forEach(res => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'result-item';
                    res.forEach(color => {
                        const ball = document.createElement('div');
                        ball.className = 'ball';
                        ball.style.backgroundColor = color;
                        itemDiv.appendChild(ball);
                    });
                    fragment.appendChild(itemDiv);
                });
                output.appendChild(fragment);

            } catch (e) {
                stats.innerText = "Помилка";
                warning.innerText = e.message || "Перевірте вхідні дані";
            }
        }, 10);
    }

    // --- ALGO LIBRARY ---

    function getPermutations(arr) {
        if (arr.length === 0) return [[]];
        const first = arr[0];
        const rest = arr.slice(1);
        const perms = getPermutations(rest);
        const all = [];
        perms.forEach((p) => {
            for (let i = 0; i <= p.length; i++) {
                all.push([...p.slice(0, i), first, ...p.slice(i)]);
            }
        });
        return all;
    }

    function getUniquePermutations(arr) {
        let results = [];
        arr.sort(); 
        function permute(current, m = []) {
            if (current.length === 0) results.push(m);
            else {
                for (let i = 0; i < current.length; i++) {
                    if (i > 0 && current[i] === current[i-1]) continue; // skip duplicates
                    let next = current.slice();
                    let picked = next.splice(i, 1);
                    permute(next, m.concat(picked));
                }
            }
        }
        permute(arr);
        return results;
    }

    function getArrangements(arr, k) {
        if (k === 0) return [[]];
        let results = [];
        for (let i = 0; i < arr.length; i++) {
            let rest = arr.slice(0, i).concat(arr.slice(i + 1));
            getArrangements(rest, k - 1).forEach(sub => results.push([arr[i], ...sub]));
        }
        return results;
    }

    function getCombinations(arr, k) {
        if (k === 0) return [[]];
        if (arr.length < k) return [];
        let head = arr[0];
        let tail = arr.slice(1);
        return getCombinations(tail, k - 1).map(c => [head, ...c]).concat(getCombinations(tail, k));
    }

    function getArrangementsRep(arr, k) {
        if (k === 0) return [[]];
        let results = [];
        let sub = getArrangementsRep(arr, k - 1);
        arr.forEach(item => sub.forEach(s => results.push([...s, item])));
        return results;
    }

    function getCombinationsRep(arr, k) {
        if (k === 0) return [[]];
        if (arr.length === 0) return [];
        let head = arr[0];
        let tail = arr.slice(1);
        let withHead = getCombinationsRep(arr, k - 1).map(c => [head, ...c]);
        let withoutHead = getCombinationsRep(tail, k);
        return withHead.concat(withoutHead);
    }

    // Init on load
    init();

</script>

</body>
</html>