<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> –ö–æ–º–±—ñ–Ω–∞—Ç–æ—Ä–∏–∫–∞ üçí</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <style>
        :root {
            --primary: #ff6b6b; /* Juicy Red */
            --secondary: #4ecdc4; /* Fresh Mint */
            --accent: #ffe66d; /* Lemon Yellow */
            --bg: #fff9f0; /* Creamy */
            --card: #ffffff;
            --text: #2d3436;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-image: radial-gradient(#ff9f43 1px, transparent 1px);
            background-size: 30px 30px;
        }

        .container {
            max-width: 1000px;
            width: 100%;
            background: var(--card);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 2px solid var(--accent);
        }

        h1 { 
            text-align: center; 
            color: var(--primary); 
            margin-bottom: 10px; 
            font-size: 2.5rem;
            text-shadow: 2px 2px 0px #ffe66d;
        }
        
        .subtitle { text-align: center; color: #636e72; margin-bottom: 25px; font-style: italic;}

        /* Tabs */
        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 25px;
            justify-content: center;
            background: #f7f1e3;
            padding: 10px;
            border-radius: 15px;
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: white;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            color: #636e72;
            border-radius: 12px;
            transition: all 0.3s;
            box-shadow: 0 4px 0 #d1ccc0;
        }

        .tab-btn:active { transform: translateY(4px); box-shadow: none; }
        .tab-btn:hover { background-color: white; color: var(--primary); transform: translateY(-2px); box-shadow: 0 6px 0 #d1ccc0;}
        .tab-btn.active { 
            background-color: var(--primary); 
            color: white; 
            box-shadow: 0 4px 0 #d63031;
        }

        /* Scenario Box */
        .scenario-box {
            background: #e0f7fa;
            border-left: 6px solid var(--secondary);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-size: 1.1rem;
        }
        .scenario-icon { font-size: 1.5rem; vertical-align: middle; margin-right: 10px; }

        /* Info Areas */
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        @media(max-width: 768px) { .info-grid { grid-template-columns: 1fr; } }

        .formula-box, .source-box {
            background: #fff;
            border: 2px dashed #dfe6e9;
            padding: 15px;
            border-radius: 12px;
        }

        .math-display { font-size: 1.2rem; margin: 10px 0; overflow-x: auto; color: #2d3436; }
        .sub-math { color: var(--primary); font-weight: bold; border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px;}

        /* Controls */
        .controls {
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid #eee;
            box-shadow: inset 0 0 10px #f1f2f6;
        }

        .input-group { margin-bottom: 15px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .input-group label { font-weight: bold; min-width: 150px; font-size: 1.1rem;}
        
        input[type="number"] {
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #dfe6e9;
            width: 80px;
            font-size: 1.2rem;
            text-align: center;
        }
        input[type="number"]:focus { border-color: var(--secondary); outline: none; }

        /* Visual Elements */
        .fruit-icon {
            font-size: 2rem;
            display: inline-block;
            margin: 2px;
            vertical-align: middle;
            filter: drop-shadow(2px 4px 2px rgba(0,0,0,0.1));
            transition: transform 0.2s;
        }
        .fruit-icon:hover { transform: scale(1.3); }

        /* Slots styling */
        .slot-machine-display {
            background: #2d3436;
            padding: 10px;
            border-radius: 10px;
            border: 4px solid #b2bec3;
            display: inline-flex;
            gap: 5px;
        }
        .slot-item {
            background: white;
            border-radius: 5px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border: 2px solid #dfe6e9;
        }

        /* Multiset UI */
        .color-picker-area { display: flex; gap: 10px; flex-wrap: wrap; }
        .fruit-slot {
            display: flex;
            align-items: center;
            gap: 5px;
            background: white;
            padding: 5px 15px;
            border-radius: 25px;
            border: 2px solid #ffe66d;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* JUICE MODE STYLES (NEW) */
        .juice-pack {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            margin: 5px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
        }
        .juice-blob {
            width: 30px; height: 30px;
            border-radius: 5px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
            margin-bottom: 4px;
        }
        .glass {
            width: 30px;
            height: 45px;
            border: 2px solid #b2bec3;
            border-top: none;
            border-radius: 0 0 10px 10px;
            background: rgba(255,255,255,0.8);
            display: inline-block;
            margin: 4px;
            position: relative;
            vertical-align: middle;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .glass.empty {
            background: repeating-linear-gradient(45deg, rgba(255,255,255,0.5), rgba(255,255,255,0.5) 5px, #f1f1f1 5px, #f1f1f1 10px);
        }
        .glass-liquid {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 75%;
            border-radius: 0 0 8px 8px;
            opacity: 0.9;
            transition: height 0.3s;
        }

        button.action-btn {
            background-color: var(--secondary);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.2rem;
            width: 100%;
            font-weight: bold;
            margin-top: 15px;
            transition: all 0.2s;
            box-shadow: 0 4px 0 #22a6b3;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        button.action-btn:hover { background-color: #43d4c8; transform: translateY(-2px); box-shadow: 0 6px 0 #22a6b3; }
        button.action-btn:active { transform: translateY(4px); box-shadow: none; }

        /* Results */
        .stats { font-size: 1.3rem; margin-bottom: 15px; font-weight: bold; text-align: center; color: var(--text); }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
            max-height: 600px;
            overflow-y: auto;
            padding: 15px;
            border: 2px solid #eee;
            border-radius: 15px;
            background: #fafafa;
        }

        .result-item {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 2px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-bottom: 3px solid #eee;
            animation: popIn 0.3s ease-out forwards;
            font-size: 1.4rem;
        }

        @keyframes popIn {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }

        .warning { color: #d63031; font-size: 0.9rem; margin-top: 10px; text-align: center; font-weight: bold;}
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #bbb; }

        /* Banana Mode Specifics */
        .banana-owner {
            font-size: 1.8rem;
            margin-right: 5px;
        }
        .banana-item {
            font-size: 1.2rem;
        }
        .banana-group {
            display: flex;
            align-items: center;
            background: #fff9c4;
            padding: 2px 8px;
            border-radius: 15px;
            margin: 2px;
        }

    </style>
</head>
<body>

<div class="container">
    <h3>–ö–æ–º–±—ñ–Ω–∞—Ç–æ—Ä–∏–∫–∞</h3>
    
    <div class="tabs" id="tabs">
        <button class="tab-btn active" onclick="setMode('perm')">üçπ –ü–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏ (P‚Çô)</button>
        <button class="tab-btn" onclick="setMode('perm_rep')">ü•ó –ü–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏ (–º—É–ª—å—Ç–∏)</button>
        <button class="tab-btn" onclick="setMode('arr')">üèÜ –†–æ–∑–º—ñ—â–µ–Ω–Ω—è (A‚Çô·µè)</button>
        <button class="tab-btn" onclick="setMode('arr_rep')">üé∞ –°–ª–æ—Ç-–º–∞—à–∏–Ω–∞ (√É‚Çô·µè)</button>
        <button class="tab-btn" onclick="setMode('comb')">ü•£ –ö–æ–º–±—ñ–Ω–∞—Ü—ñ—ó (C‚Çô·µè)</button>
        <button class="tab-btn" onclick="setMode('comb_rep')">üêµ –ë–∞–Ω–∞–Ω–∏ —Ç–∞ –î—Ä—É–∑—ñ (CÃÉ‚Çô·µè)</button>
        <button class="tab-btn" onclick="setMode('comb_rep_juice')">ü•§ –°–æ–∫–∏ —Ç–∞ –°–∫–ª—è–Ω–∫–∏ (CÃÉ‚Çô·µè)</button>
    </div>

    <div id="scenario-text" class="scenario-box">
        <span class="scenario-icon">üí°</span> –í–∏–±–µ—Ä—ñ—Ç—å —Ä–µ–∂–∏–º –¥–ª—è –ø–æ—á–∞—Ç–∫—É...
    </div>

    <div class="info-grid">
        <div class="formula-box">
            <strong>üßÆ –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞:</strong>
            <div id="formula-display" class="math-display">$$ P_n = n! $$</div>
            <div id="substitution-display" class="sub-math"></div>
        </div>
        <div class="source-box">
            <strong>üì¶ –©–æ —î –≤ –∫–æ–º–æ—Ä—ñ (N):</strong>
            <div id="source-visualization" style="margin-top:10px; font-size: 1.5rem;"></div>
        </div>
    </div>

    <div class="controls">
        <div id="dynamic-inputs"></div>
        <div id="limit-warning" class="warning"></div>
        <button class="action-btn" onclick="calculate()">üé≤ –ó–º—ñ—à–∞—Ç–∏ —Ç–∞ –ü–æ—Ä–∞—Ö—É–≤–∞—Ç–∏!</button>
    </div>

    <div class="stats" id="stats-output">–†–µ–∑—É–ª—å—Ç–∞—Ç: 0 –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤</div>
    <div class="results-grid" id="visual-output"></div>
</div>

<script>
    // --- CONFIG & DATA ---
    let currentMode = 'perm';
    const FRUITS = ['üçé','üçå','üçá','ü•ù','üçç','üçâ','üçì','üçí','üçë','üçã'];
    const PEOPLE = ['üêµ','üë¥','üë©','üë®','üëΩ','ü§ñ']; // For banana mode

    // Color mapping for Juice Mode
  // Color mapping for Juice Mode
    const JUICE_COLORS = {
		'ü•ù': '#2ecc71', // –ö—ñ–≤—ñ (–Ø—Å–∫—Ä–∞–≤–æ-–∑–µ–ª–µ–Ω–∏–π)
       	'üçì': '#c0392b', // –ü–æ–ª—É–Ω–∏—Ü—è (–¢–µ–º–Ω–æ-–±–æ—Ä–¥–æ–≤–∏–π)
        'üçå': '#f1c40f', // –ë–∞–Ω–∞–Ω (–ñ–æ–≤—Ç–∏–π)
        'üçá': '#8e44ad', // –í–∏–Ω–æ–≥—Ä–∞–¥ (–§—ñ–æ–ª–µ—Ç–æ–≤–∏–π)
		'üçç': '#f39c12', // –ê–Ω–∞–Ω–∞—Å (–ü–æ–º–∞—Ä–∞–Ω—á–µ–≤–∏–π)
        'üçâ': '#ff9ff3', // –ö–∞–≤—É–Ω (–ù–µ–æ–Ω–æ–≤–æ-—Ä–æ–∂–µ–≤–∏–π - –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç—É)
         'üçé': '#e74c3c', // –Ø–±–ª—É–∫–æ (–Ø—Å–∫—Ä–∞–≤–æ-—á–µ—Ä–≤–æ–Ω–∏–π)
        'üçí': '#2c3e50', // –í–∏—à–Ω—è (–¢–µ–º–Ω–æ-—Å–∏–Ω—ñ–π/–ß–æ—Ä–Ω–∏–π, —è–∫ —á–µ—Ä–µ—à–Ω—è - —â–æ–± –≤—ñ–¥—Ä—ñ–∑–Ω—è–ª–∞—Å—å –≤—ñ–¥ —è–±–ª—É–∫–∞)
            
        'üçë': '#ffcccc', // –ü–µ—Ä—Å–∏–∫ (–ë–ª—ñ–¥–æ-—Ä–æ–∂–µ–≤–∏–π)
        'üçã': '#f6e58d'  // –õ–∏–º–æ–Ω (–ë–ª—ñ–¥–æ-–∂–æ–≤—Ç–∏–π)
    };

    // State for multiset inputs (Fruit Salad)
    let multisetState = [
        { icon: FRUITS[0], count: 2 }, // Apples
        { icon: FRUITS[1], count: 1 }  // Bananas
    ];

    const SCENARIOS = {
        perm: "üçπ <b>–ß–µ—Ä–≥–∞ –Ω–∞ —Å–º—É–∑—ñ:</b> –£ —è–∫–æ–º—É –ø–æ—Ä—è–¥–∫—É –º–∏ –º–æ–∂–µ–º–æ –∑–∞–∫–∏–Ω—É—Ç–∏ —Ü—ñ —Ñ—Ä—É–∫—Ç–∏ —É –±–ª–µ–Ω–¥–µ—Ä? –ü–æ—Ä—è–¥–æ–∫ —à–∞—Ä—ñ–≤ –≤–∞–∂–ª–∏–≤–∏–π –¥–ª—è –∫—Ä–∞—Å–∏!",
        perm_rep: "ü•ó <b>–§—Ä—É–∫—Ç–æ–≤–∞ —Ç–∞—Ä—ñ–ª–∫–∞:</b> –£ –Ω–∞—Å —î –∫—ñ–ª—å–∫–∞ –æ–¥–Ω–∞–∫–æ–≤–∏—Ö —Ñ—Ä—É–∫—Ç—ñ–≤. –°–∫—ñ–ª—å–∫–æ–º–∞ —Å–ø–æ—Å–æ–±–∞–º–∏ —ó—Ö –º–æ–∂–Ω–∞ –≤–∏–∫–ª–∞—Å—Ç–∏ –≤ —Ä—è–¥? (–î–≤–∞ —è–±–ª—É–∫–∞ –æ–¥–Ω–∞–∫–æ–≤—ñ!)",
        arr: "üèÜ <b>–ö–æ–Ω–∫—É—Ä—Å –∫—Ä–∞—Å–∏:</b> –£ –Ω–∞—Å —î –∫—É–ø–∞ —Ñ—Ä—É–∫—Ç—ñ–≤, –∞–ª–µ –ø—Ä–∏–∑–æ–≤–∏—Ö –º—ñ—Å—Ü—å –ª–∏—à–µ –¥–µ–∫—ñ–ª—å–∫–∞ (1-—à–µ, 2-–≥–µ...). –•—Ç–æ –ø–µ—Ä–µ–º–æ–∂–µ?",
        arr_rep: "üé∞ <b>–§—Ä—É–∫—Ç–æ–≤–∏–π –∑–∞–º–æ–∫:</b> –ö–æ–¥–æ–≤–∏–π –∑–∞–º–æ–∫ –Ω–∞ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫—É! –ù–∞ –∫–æ–∂–Ω–æ–º—É –∫–æ–ª–µ—Å—ñ (K) —î –≤—Å—ñ –≤–∏–¥–∏ —Ñ—Ä—É–∫—Ç—ñ–≤ (N). –§—Ä—É–∫—Ç–∏ –º–æ–∂—É—Ç—å –ø–æ–≤—Ç–æ—Ä—é–≤–∞—Ç–∏—Å—å.",
        comb: "ü•£ <b>–§—Ä—É–∫—Ç–æ–≤–∏–π —Å–∞–ª–∞—Ç:</b> –ö–∏–¥–∞—î–º–æ —Ñ—Ä—É–∫—Ç–∏ –≤ –º–∏—Å–∫—É. –ü–æ—Ä—è–¥–æ–∫ –Ω–µ –≤–∞–∂–ª–∏–≤–∏–π ‚Äî –≥–æ–ª–æ–≤–Ω–µ, —â–æ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ. (–Ø–±–ª—É–∫–æ+–ì—Ä—É—à–∞ = –ì—Ä—É—à–∞+–Ø–±–ª—É–∫–æ).",
        comb_rep: "üçå <b>–†–æ–∑–¥–∞—á–∞ –±–∞–Ω–∞–Ω—ñ–≤:</b> –£ –Ω–∞—Å —î –∑–∞–ø–∞—Å –±–∞–Ω–∞–Ω—ñ–≤ (K). –ú–∏ —Ä–æ–∑–¥–∞—î–º–æ —ó—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º (N). –ö–æ–º—É —Å–∫—ñ–ª—å–∫–∏ –¥—ñ—Å—Ç–∞–Ω–µ—Ç—å—Å—è?",
        comb_rep_juice: "ü•§ <b>–°–æ–∫–æ–≤–∏–π –±–∞—Ä:</b> –£ –Ω–∞—Å —î –≤–∏–¥–∏ —Å–æ–∫—ñ–≤ (N) —Ç–∞ –æ–¥–Ω–∞–∫–æ–≤—ñ –ø–æ—Ä–æ–∂–Ω—ñ —Å–∫–ª—è–Ω–∫–∏ (K). –ù–∞–ø–æ–≤–Ω—é—î–º–æ —Å–∫–ª—è–Ω–∫–∏ —Å–æ–∫–æ–º. –Ø–∫—ñ –Ω–∞–±–æ—Ä–∏ –Ω–∞–ø–æ—ó–≤ –º–∏ –º–æ–∂–µ–º–æ –æ—Ç—Ä–∏–º–∞—Ç–∏?"
    };

    // --- INIT ---
    function init() {
        updateUI();
    }

    // --- MODE SWITCHING ---
    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        updateUI();
        
        // Clear results
        document.getElementById('visual-output').innerHTML = '<div style="padding:20px; text-align:center; color:#999; width:100%; grid-column: 1/-1;">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É</div>';
        document.getElementById('stats-output').innerText = '';
    }

    // --- UI RENDERING ---
    function updateUI() {
        const container = document.getElementById('dynamic-inputs');
        const formulaDisplay = document.getElementById('formula-display');
        const scenarioDisplay = document.getElementById('scenario-text');
        
        scenarioDisplay.innerHTML = `<span class="scenario-icon">üí°</span> ${SCENARIOS[currentMode]}`;

        let html = '';
        let formula = '';

        switch(currentMode) {
            case 'perm':
                html = getInputHtml('–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ñ—Ä—É–∫—Ç—ñ–≤ (N):', 'inp-n', 3, 1, 8);
                formula = '$$ P_n = n! $$';
                break;
            case 'perm_rep':
                html = getMultisetUI('–°–∫–ª–∞–¥ —Ç–∞—Ä—ñ–ª–∫–∏:');
                formula = '$$ P_n(n_1, n_2...) = \\frac{n!}{n_1!n_2!...} $$';
                break;
            case 'arr':
                html = getInputHtml('–í—Å—å–æ–≥–æ —Ñ—Ä—É–∫—Ç—ñ–≤ (N):', 'inp-n', 4, 1, 8) + 
                       getInputHtml('–ü—Ä–∏–∑–æ–≤–∏—Ö –º—ñ—Å—Ü—å (K):', 'inp-k', 2, 1, 8);
                formula = '$$ A_n^k = \\frac{n!}{(n-k)!} $$';
                break;
            case 'arr_rep':
                html = getInputHtml('–í–∏–¥–∏ —Ñ—Ä—É–∫—Ç—ñ–≤ (N):', 'inp-n', 3, 1, 6) + 
                       getInputHtml('–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Å–ª–æ—Ç—ñ–≤ (K):', 'inp-k', 3, 1, 5);
                formula = '$$ \\tilde{A}_n^k = n^k $$';
                break;
            case 'comb':
                html = getInputHtml('–í—Å—å–æ–≥–æ —Ñ—Ä—É–∫—Ç—ñ–≤ (N):', 'inp-n', 5, 1, 10) + 
                       getInputHtml('–í–∑—è—Ç–∏ –≤ —Å–∞–ª–∞—Ç (K):', 'inp-k', 3, 1, 10);
                formula = '$$ C_n^k = \\frac{n!}{k!(n-k)!} $$';
                break;
            case 'comb_rep':
                html = getInputHtml('–ü–µ—Ä—Å–æ–Ω–∞–∂—ñ (N):', 'inp-n', 3, 1, 6) + 
                       getInputHtml('–ë–∞–Ω–∞–Ω—ñ–≤ —Ä–æ–∑–¥–∞—Ç–∏ (K):', 'inp-k', 4, 1, 8);
                formula = '$$ \\tilde{C}_n^k = C_{n+k-1}^k $$';
                break;
            case 'comb_rep_juice':
                html = getInputHtml('–í–∏–¥–∏ —Å–æ–∫—ñ–≤ (N):', 'inp-n', 3, 1, 6) + 
                       getInputHtml('–°–∫–ª—è–Ω–æ–∫ (K):', 'inp-k', 4, 1, 8);
                formula = '$$ \\tilde{C}_n^k = C_{n+k-1}^k = \\frac{(n+k-1)!}{k!(n-1)!} $$';
                break;
        }

        container.innerHTML = html;
        formulaDisplay.innerHTML = formula;
        if(window.MathJax) MathJax.Hub.Queue(["Typeset", MathJax.Hub, formulaDisplay]);
        updatePreview();
    }

    function getInputHtml(label, id, val, min, max) {
        return `
            <div class="input-group">
                <label>${label}</label>
                <input type="number" id="${id}" value="${val}" min="${min}" max="${max}" onchange="updatePreview()" oninput="updatePreview()">
            </div>`;
    }

    function getMultisetUI(label) {
        let listHtml = multisetState.map((item, idx) => `
            <div class="fruit-slot">
                <span style="font-size:1.5rem">${item.icon}</span>
                <input type="number" min="1" max="5" value="${item.count}" onchange="updateMultisetCount(${idx}, this.value)" style="width:50px; padding:5px;">
                <button onclick="removeMultisetItem(${idx})" style="border:none;background:none;cursor:pointer;color:red;font-weight:bold;font-size:1.2em">&times;</button>
            </div>
        `).join('');

        return `
            <div class="input-group">
                <label>${label}</label>
                <div class="color-picker-area" id="multiset-list">
                    ${listHtml}
                    <button onclick="addMultisetItem()" style="border:2px dashed var(--secondary); color:var(--secondary); background:white; padding:5px 15px; border-radius:20px; cursor:pointer; font-weight:bold">+ –§—Ä—É–∫—Ç</button>
                </div>
            </div>
        `;
    }

    // --- LIVE PREVIEW ---
    function updatePreview() {
        updateSourceVisuals();
        updateSubstitutionMath();
    }

    function updateSourceVisuals() {
        const container = document.getElementById('source-visualization');
        container.innerHTML = '';

        let n = 0, k = 0;
        const nEl = document.getElementById('inp-n');
        const kEl = document.getElementById('inp-k');
        if(nEl) n = parseInt(nEl.value);
        if(kEl) k = parseInt(kEl.value);

        // Visual Helper function
        const makeGroup = (label, content) => `<div style="display:flex; align-items:center; gap:10px; margin-bottom:5px;"><span style="font-size:0.9rem; font-weight:bold; color:#666; text-transform:uppercase;">${label}:</span> ${content}</div>`;

        if(currentMode === 'comb_rep') {
            // Special Banana Mode
            let pplHtml = '';
            for(let i=0; i<n; i++) pplHtml += `<span class="fruit-icon">${PEOPLE[i] || '?'}</span>`;
            container.innerHTML = `<div>–í–ª–∞—Å–Ω–∏–∫–∏ (N=${n}): ${pplHtml}</div>`;
            container.innerHTML += `<div style="margin-top:5px; font-size:1rem; color:#666">–†–æ–∑–¥–∞—î–º–æ üçå: ${k} —à—Ç.</div>`;
            return;
        }

        if(currentMode === 'comb_rep_juice') {
            // New Juice Mode
            let juiceHtml = '';
            for(let i=0; i<n; i++) {
                const fruit = FRUITS[i] || '?';
                const color = JUICE_COLORS[fruit] || '#ccc';
                juiceHtml += `<div class="juice-pack"><div class="juice-blob" style="background:${color}"></div><span>${fruit}</span></div>`;
            }
            container.innerHTML = makeGroup(`–°–æ–∫–∏ (N=${n})`, juiceHtml);
            
            let glassesHtml = '';
            for(let i=0; i<k; i++) {
                glassesHtml += `<div class="glass empty"></div>`;
            }
            container.innerHTML += makeGroup(`–°–∫–ª—è–Ω–∫–∏ (K=${k})`, glassesHtml);
            return;
        }

        if (['perm', 'arr', 'comb', 'arr_rep'].includes(currentMode)) {
            let fruitsHtml = '';
            for(let i=0; i<n; i++) {
                fruitsHtml += `<span class="fruit-icon">${FRUITS[i]}</span>`;
            }
            container.innerHTML = fruitsHtml;
        }
        else if (currentMode === 'perm_rep') {
            let itemsHtml = '';
            multisetState.forEach(item => {
                for(let i=0; i<item.count; i++) itemsHtml += `<span class="fruit-icon">${item.icon}</span>`;
            });
            container.innerHTML = itemsHtml;
        }
    }

    function updateSubstitutionMath() {
        const display = document.getElementById('substitution-display');
        let latex = '';
        let n = 0, k = 0;
        const nEl = document.getElementById('inp-n');
        const kEl = document.getElementById('inp-k');
        if(nEl) n = parseInt(nEl.value);
        if(kEl) k = parseInt(kEl.value);

        const fact = (num) => {
            if (num < 0) return 0;
            let r = 1; for(let i=2; i<=num; i++) r*=i; 
            return r;
        };

        if (currentMode === 'perm') {
            latex = `$$ P_{${n}} = ${n}! = ${fact(n)} $$`;
        }
        else if (currentMode === 'arr') {
            if(k > n) latex = `$$ k > n \\rightarrow 0 $$`;
            else latex = `$$ A_{${n}}^{${k}} = \\frac{${n}!}{${n-k}!} = ${fact(n)/fact(n-k)} $$`;
        }
        else if (currentMode === 'comb') {
            if(k > n) latex = `$$ k > n \\rightarrow 0 $$`;
            else latex = `$$ C_{${n}}^{${k}} = \\frac{${n}!}{${k}!${n-k}!} = ${Math.round(fact(n)/(fact(k)*fact(n-k)))} $$`;
        }
        else if (currentMode === 'arr_rep') {
            latex = `$$ \\tilde{A}_{${n}}^{${k}} = ${n}^{${k}} = ${Math.pow(n, k)} $$`;
        }
        else if (currentMode === 'comb_rep' || currentMode === 'comb_rep_juice') {
            // Banana math & Juice math
            let top = n + k - 1;
            let val = Math.round(fact(top) / (fact(k) * fact(top-k)));
            latex = `$$ \\tilde{C}_{${n}}^{${k}} = C_{${top}}^{${k}} = \\frac{${top}!}{${k}!${n-1}!} = ${val} $$`;
        }
        else if (currentMode === 'perm_rep') {
            let total = 0;
            let denoms = [];
            let denomVal = 1;
            multisetState.forEach(i => {
                total += i.count;
                denoms.push(`${i.count}!`);
                denomVal *= fact(i.count);
            });
            let numVal = fact(total);
            latex = `$$ P = \\frac{${total}!}{${denoms.join('\\cdot')}} = ${Math.round(numVal / denomVal)} $$`;
        }

        display.innerHTML = latex;
        if(window.MathJax) MathJax.Hub.Queue(["Typeset", MathJax.Hub, display]);
    }

    // --- MULTISET LOGIC ---
    window.addMultisetItem = function() {
        const usedIcons = multisetState.map(m => m.icon);
        const available = FRUITS.find(c => !usedIcons.includes(c));
        if(available) {
            multisetState.push({ icon: available, count: 1 });
            updateUI();
        } else {
            alert("–í—Å—ñ –¥–æ—Å—Ç—É–ø–Ω—ñ —Ñ—Ä—É–∫—Ç–∏ –≤–∂–µ —É —Å–∞–ª–∞—Ç—ñ!");
        }
    }
    window.removeMultisetItem = function(idx) {
        multisetState.splice(idx, 1);
        updateUI();
    }
    window.updateMultisetCount = function(idx, val) {
        multisetState[idx].count = parseInt(val);
        updatePreview();
    }

    // --- CALCULATION ---
    function calculate() {
        const output = document.getElementById('visual-output');
        const stats = document.getElementById('stats-output');
        const warning = document.getElementById('limit-warning');
        
        output.innerHTML = '';
        warning.innerText = '';
        stats.innerText = '‚è≥ –†–∞—Ö—É—î–º–æ...';

        setTimeout(() => {
            let results = [];
            let limit = 2000;

            try {
                if (currentMode === 'perm') {
                    const n = parseInt(document.getElementById('inp-n').value);
                    results = getPermutations(FRUITS.slice(0, n));
                }
                else if (currentMode === 'arr') {
                    const n = parseInt(document.getElementById('inp-n').value);
                    const k = parseInt(document.getElementById('inp-k').value);
                    if(k > n) throw new Error("–ú–∞–ª–æ —Ñ—Ä—É–∫—Ç—ñ–≤ –¥–ª—è —Å—Ç—ñ–ª—å–∫–æ—Ö –º—ñ—Å—Ü—å!");
                    results = getArrangements(FRUITS.slice(0, n), k);
                }
                else if (currentMode === 'comb') {
                    const n = parseInt(document.getElementById('inp-n').value);
                    const k = parseInt(document.getElementById('inp-k').value);
                    if(k > n) throw new Error("–ú–∞–ª–æ —Ñ—Ä—É–∫—Ç—ñ–≤!");
                    results = getCombinations(FRUITS.slice(0, n), k);
                }
                else if (currentMode === 'arr_rep') {
                    const n = parseInt(document.getElementById('inp-n').value);
                    const k = parseInt(document.getElementById('inp-k').value);
                    results = getArrangementsRep(FRUITS.slice(0, n), k);
                }
                else if (currentMode === 'comb_rep') {
                    // Banana Distribution
                    const n = parseInt(document.getElementById('inp-n').value); // Owners
                    const k = parseInt(document.getElementById('inp-k').value); // Bananas
                    const owners = PEOPLE.slice(0, n);
                    const rawCombs = getCombinationsRep(owners, k);
                    results = rawCombs.map(comb => {
                        let distribution = {};
                        owners.forEach(o => distribution[o] = 0);
                        comb.forEach(o => distribution[o]++);
                        return { type: 'banana_dist', data: distribution };
                    });
                }
                else if (currentMode === 'comb_rep_juice') {
                    // Juice & Glasses (same logic as generic CombRep with balls)
                    const n = parseInt(document.getElementById('inp-n').value);
                    const k = parseInt(document.getElementById('inp-k').value);
                    results = getCombinationsRep(FRUITS.slice(0, n), k);
                }
                else if (currentMode === 'perm_rep') {
                    let pool = [];
                    multisetState.forEach(item => {
                        for(let i=0; i<item.count; i++) pool.push(item.icon);
                    });
                    if(pool.length > 10) warning.innerText = "‚ö†Ô∏è –í–µ–ª–∏–∫–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –µ–ª–µ–º–µ–Ω—Ç—ñ–≤, –ø–æ–∫–∞–∑–∞–Ω–æ –Ω–µ –≤—Å—ñ.";
                    results = getUniquePermutations(pool);
                }

                stats.innerText = `‚ö° –í—Å—å–æ–≥–æ –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤: ${results.length}`;
                
                if(results.length > limit) {
                    warning.innerText = `–ü–æ–∫–∞–∑–∞–Ω–æ –ø–µ—Ä—à—ñ ${limit}. –†–µ—à—Ç–∞ –Ω–µ –≤–º—ñ—Å—Ç–∏–ª–∞—Å—è.`;
                    results = results.slice(0, limit);
                }

                const fragment = document.createDocumentFragment();
                
                results.forEach(res => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'result-item';
                    
                    if(currentMode === 'arr_rep') {
                        // Slot machine look
                        itemDiv.style.backgroundColor = "#2d3436";
                        itemDiv.innerHTML = res.map(icon => `<div class="slot-item">${icon}</div>`).join('');
                    } 
                    else if (currentMode === 'comb_rep') {
                        // Banana owners look
                        let html = '';
                        for (const [owner, count] of Object.entries(res.data)) {
                            if(count > 0) {
                                let bananas = 'üçå'.repeat(count);
                                html += `<div class="banana-group"><span class="banana-owner">${owner}</span><span class="banana-item">${bananas}</span></div>`;
                            }
                        }
                        itemDiv.innerHTML = html;
                    }
                    else if (currentMode === 'comb_rep_juice') {
                        // Juice Glasses look
                        let html = '';
                        res.forEach(fruit => {
                             const color = JUICE_COLORS[fruit] || '#ccc';
                             html += `<div class="glass" title="${fruit}"><div class="glass-liquid" style="background:${color}"></div></div>`;
                        });
                        itemDiv.innerHTML = html;
                    }
                    else {
                        // Standard fruit list
                        itemDiv.innerHTML = res.join('');
                    }
                    
                    fragment.appendChild(itemDiv);
                });
                output.appendChild(fragment);

            } catch (e) {
                stats.innerText = "–û–π...";
                warning.innerText = e.message;
            }
        }, 50); // slight delay for UI update
    }

    // --- MATH ALGORITHMS ---
    function getPermutations(arr) {
        if (arr.length === 0) return [[]];
        const first = arr[0];
        const rest = arr.slice(1);
        const perms = getPermutations(rest);
        const all = [];
        perms.forEach((p) => {
            for (let i = 0; i <= p.length; i++) {
                all.push([...p.slice(0, i), first, ...p.slice(i)]);
            }
        });
        return all;
    }

    function getUniquePermutations(arr) {
        let results = [];
        arr.sort(); 
        function permute(current, m = []) {
            if (current.length === 0) results.push(m);
            else {
                for (let i = 0; i < current.length; i++) {
                    if (i > 0 && current[i] === current[i-1]) continue;
                    let next = current.slice();
                    let picked = next.splice(i, 1);
                    permute(next, m.concat(picked));
                }
            }
        }
        permute(arr);
        return results;
    }

    function getArrangements(arr, k) {
        if (k === 0) return [[]];
        let results = [];
        for (let i = 0; i < arr.length; i++) {
            let rest = arr.slice(0, i).concat(arr.slice(i + 1));
            getArrangements(rest, k - 1).forEach(sub => results.push([arr[i], ...sub]));
        }
        return results;
    }

    function getCombinations(arr, k) {
        if (k === 0) return [[]];
        if (arr.length < k) return [];
        let head = arr[0];
        let tail = arr.slice(1);
        return getCombinations(tail, k - 1).map(c => [head, ...c]).concat(getCombinations(tail, k));
    }

    function getArrangementsRep(arr, k) {
        if (k === 0) return [[]];
        let results = [];
        let sub = getArrangementsRep(arr, k - 1);
        arr.forEach(item => sub.forEach(s => results.push([...s, item])));
        return results;
    }

    function getCombinationsRep(arr, k) {
        if (k === 0) return [[]];
        if (arr.length === 0) return [];
        let head = arr[0]; // This represents an Owner type (or Juice Type)
        let tail = arr.slice(1);
        
        let withHead = getCombinationsRep(arr, k - 1).map(c => [head, ...c]);
        
        let withoutHead = getCombinationsRep(tail, k);
        return withHead.concat(withoutHead);
    }

    init();
</script>
</body>
</html>