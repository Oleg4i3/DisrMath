<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏–º—É–ª—è—Ç–æ—Ä –ê–ª–≥–æ—Ä–∏—Ç–º—É –ö—Ä—É—Å–∫–∞–ª–∞</title>
    <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f8f9fa;
            color: #212529;
            margin: 0;
            padding: 20px;
        }
        h1, p {
            text-align: center;
        }

        /* --- –ù–æ–≤–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ --- */
        #main-container {
            display: flex;
            flex-wrap: wrap; /* –î–æ–∑–≤–æ–ª—è—î –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç–∏ –ø—Ä–∞–≤—É –ø–∞–Ω–µ–ª—å –≤–Ω–∏–∑ –Ω–∞ –º–∞–ª–∏—Ö –µ–∫—Ä–∞–Ω–∞—Ö */
            gap: 20px;
            margin-bottom: 20px;
        }

        /* –ö–∞–Ω–≤–∞ –≥—Ä–∞—Ñ–∞ (–∑–ª—ñ–≤–∞) */
        #cy {
            flex: 1; /* –ó–∞–π–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏–π –ø—Ä–æ—Å—Ç—ñ—Ä */
            min-width: 500px; /* –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ —à–∏—Ä–∏–Ω–∞ */
            height: 700px; /* –ó–±—ñ–ª—å—à–µ–Ω–∞ –≤–∏—Å–æ—Ç–∞ */
            display: block;
            border: 1px solid #ced4da;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        /* –ü—Ä–∞–≤–∞ –ø–∞–Ω–µ–ª—å */
        #right-panel {
            flex: 1;
            min-width: 320px;
            max-width: 400px; /* –û–±–º–µ–∂—É—î–º–æ —à–∏—Ä–∏–Ω—É –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç—ñ */
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* –ë–ª–æ–∫ –∫–µ—Ä—É–≤–∞–Ω–Ω—è */
        #controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 20px;
            background: #fff;
            border: 1px solid #ced4da;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        #gen-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #gen-controls label {
            margin: 0;
            font-size: 16px;
        }
        #gen-controls input {
            width: 60px;
            flex: 1;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ced4da;
            border-radius: 5px;
        }
        #gen-controls button {
            flex: 2;
        }

        #step-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        /* –°—Ç–∏–ª—å –∫–Ω–æ–ø–æ–∫ */
        button {
            padding: 12px 10px;
            font-size: 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px; /* –í—ñ–¥—Å—Ç–∞–Ω—å –º—ñ–∂ —ñ–∫–æ–Ω–∫–æ—é —Ç–∞ —Ç–µ–∫—Å—Ç–æ–º */
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #c0c0c0;
            cursor: not-allowed;
        }
        #btnGenerate {
            background-color: #17a2b8;
        }
        #btnGenerate:hover {
            background-color: #117a8b;
        }
        #btnReset {
            background-color: #dc3545;
        }
        #btnReset:hover {
            background-color: #b02a37;
        }
        #btnStart {
            background-color: #28a745;
        }
        #btnStart:hover {
            background-color: #218838;
        }

        /* –í—ñ–∫–Ω–æ –ª–æ–≥—É */
        #log {
            flex-grow: 1; /* –ó–∞–π–º–∞—î —Ä–µ—à—Ç—É –º—ñ—Å—Ü—è –Ω–∞ –ø—Ä–∞–≤—ñ–π –ø–∞–Ω–µ–ª—ñ */
            height: auto;
            min-height: 200px;
            max-height: 480px; /* –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ –∑ –≤–∏—Å–æ—Ç–æ—é –ø–∞–Ω–µ–ª—ñ */
            width: 100%;
            margin: 0;
            padding: 15px;
            background-color: #fff;
            border: 1px solid #ced4da;
            border-radius: 8px;
            overflow-y: auto;
            text-align: left;
            font-family: "Courier New", Courier, monospace;
            font-size: 14px;
            line-height: 1.5;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            box-sizing: border-box; /* –í–∫–ª—é—á–∞—î padding –≤ —à–∏—Ä–∏–Ω—É */
        }

        /* –°–µ–∫—Ü—ñ—è –∑ –æ–ø–∏—Å–æ–º (–≤–Ω–∏–∑—É) */
        details {
            width: 100%; /* –ó–∞–π–º–∞—î –≤—Å—é —à–∏—Ä–∏–Ω—É –ø—ñ–¥ –æ—Å–Ω–æ–≤–Ω–æ—é —Å–µ–∫—Ü—ñ—î—é */
            margin: 0;
            text-align: left;
            background-color: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
        }
        summary {
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h2>–°–∏–º—É–ª—è—Ç–æ—Ä –∞–ª–≥–æ—Ä–∏—Ç–º—É –ö—Ä—É—Å–∫–∞–ª–∞</h2>
   
    <div id="main-container">
        <div id="cy"></div>

        <div id="right-panel">
            <div id="controls">
                <div id="gen-controls">
                    <label for="numNodes">–í–µ—Ä—à–∏–Ω:</label>
                    <input type="number" id="numNodes" min="3" max="20" value="7">
                    <button id="btnGenerate">üîÑ –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏</button>
                </div>
                <div id="step-controls">
                    <button id="btnStepBack">‚è™ –ö—Ä–æ–∫ –ù–∞–∑–∞–¥</button>
                    <button id="btnStepForward">‚è© –ö—Ä–æ–∫ –í–ø–µ—Ä–µ–¥</button>
                </div>
                <button id="btnStart">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –ê–ª–≥–æ—Ä–∏—Ç–º</button>
                <button id="btnReset">‚èπÔ∏è –°–∫–∏–Ω—É—Ç–∏ –ì—Ä–∞—Ñ</button>
            </div>
            
            <div id="log"></div>
        </div>
    </div>

    <details>
        <summary>–û–ø–∏—Å –∞–ª–≥–æ—Ä–∏—Ç–º—É —Ç–∞ —Å—Ü–µ–Ω–∞—Ä—ñ—ó –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è</summary>
        <div>
            <h3>–û–ø–∏—Å –∞–ª–≥–æ—Ä–∏—Ç–º—É –ö—Ä—É—Å–∫–∞–ª–∞</h3>
            <p>–ê–ª–≥–æ—Ä–∏—Ç–º –ö—Ä—É—Å–∫–∞–ª–∞ ‚Äî —Ü–µ –∂–∞–¥—ñ–±–Ω–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º –¥–ª—è –∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ–≥–æ –∫—ñ—Å—Ç—è–∫–æ–≤–æ–≥–æ –¥–µ—Ä–µ–≤–∞ ( minimum spanning tree - MST) —É –∑–≤–∞–∂–µ–Ω–æ–º—É –Ω–µ–æ—Ä—ñ—î–Ω—Ç–æ–≤–∞–Ω–æ–º—É –≥—Ä–∞—Ñ—ñ. –ö—Ä–æ–∫–∏ –∞–ª–≥–æ—Ä–∏—Ç–º—É:</p>
            <ol>
                <li>–°–æ—Ä—Ç—É–≤–∞—Ç–∏ –≤—Å—ñ —Ä–µ–±—Ä–∞ –≥—Ä–∞—Ñ–∞ –∑–∞ –∑—Ä–æ—Å—Ç–∞–Ω–Ω—è–º –≤–∞–≥–∏.</li>
                <li>–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É Union-Find –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∑–≤'—è–∑–Ω–æ—Å—Ç—ñ.</li>
                <li>–ü–æ—á–∏–Ω–∞—é—á–∏ –∑ –Ω–∞–π–º–µ–Ω—à–æ–≥–æ —Ä–µ–±—Ä–∞, –¥–æ–¥–∞–≤–∞—Ç–∏ —Ä–µ–±—Ä–æ –¥–æ MST, —è–∫—â–æ –≤–æ–Ω–æ –∑'—î–¥–Ω—É—î —Ä—ñ–∑–Ω—ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ (–Ω–µ —É—Ç–≤–æ—Ä—é—î —Ü–∏–∫–ª).</li>
                <li>–ü–æ–≤—Ç–æ—Ä—é–≤–∞—Ç–∏, –¥–æ–∫–∏ MST –Ω–µ –º—ñ—Å—Ç–∏—Ç–∏–º–µ –≤—Å—ñ –≤–µ—Ä—à–∏–Ω–∏ –≥—Ä–∞—Ñ–∞ (–∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–µ–±–µ—Ä = –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≤–µ—Ä—à–∏–Ω - 1).</li>
            </ol>
            <h3>–°—Ü–µ–Ω–∞—Ä—ñ—ó –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –ø–æ—à—É–∫—É –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ–≥–æ –∫—ñ—Å—Ç—è–∫–æ–≤–æ–≥–æ –¥–µ—Ä–µ–≤–∞</h3>
            <ul>
                <li>–ü—Ä–æ–µ–∫—Ç—É–≤–∞–Ω–Ω—è –º–µ—Ä–µ–∂: –º—ñ–Ω—ñ–º—ñ–∑–∞—Ü—ñ—è –≤–∞—Ä—Ç–æ—Å—Ç—ñ –∫–∞–±–µ–ª—ñ–≤, –¥–æ—Ä—ñ–≥ –∞–±–æ —Ç—Ä—É–±–æ–ø—Ä–æ–≤–æ–¥—ñ–≤ –¥–ª—è –∑'—î–¥–Ω–∞–Ω–Ω—è —Ç–æ—á–æ–∫.</li>
                <li>–ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö: –≥—Ä—É–ø—É–≤–∞–Ω–Ω—è –æ–±'—î–∫—Ç—ñ–≤ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –≤—ñ–¥—Å—Ç–∞–Ω–µ–π (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —É –º–∞—à–∏–Ω–Ω–æ–º—É –Ω–∞–≤—á–∞–Ω–Ω—ñ).</li>
                <li>–ê–ø—Ä–æ–∫—Å–∏–º–∞—Ü—ñ—è –∑–∞–¥–∞—á: –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∞–ø—Ä–æ–∫—Å–∏–º–∞—Ü—ñ—è –∑–∞–¥–∞—á—ñ –∫–æ–º—ñ–≤–æ—è–∂–µ—Ä–∞ –¥–ª—è –∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –∫–æ—Ä–æ—Ç–∫–æ–≥–æ —à–ª—è—Ö—É.</li>
                <li>–ë—ñ–æ—ñ–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞: –ø–æ–±—É–¥–æ–≤–∞ —Ñ—ñ–ª–æ–≥–µ–Ω–µ—Ç–∏—á–Ω–∏—Ö –¥–µ—Ä–µ–≤ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –≥–µ–Ω–µ—Ç–∏—á–Ω–∏—Ö –≤—ñ–¥—Å—Ç–∞–Ω–µ–π.</li>
                <li>–ö–æ–º–ø'—é—Ç–µ—Ä–Ω—ñ –º–µ—Ä–µ–∂—ñ: –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è —Ç–æ–ø–æ–ª–æ–≥—ñ—ó –¥–ª—è –∑–º–µ–Ω—à–µ–Ω–Ω—è –∑–∞—Ç—Ä–∏–º–æ–∫ –∞–±–æ –≤–∏—Ç—Ä–∞—Ç.</li>
                <li>–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è: —Å–µ–≥–º–µ–Ω—Ç–∞—Ü—ñ—è –∑–æ–±—Ä–∞–∂–µ–Ω—å –∞–±–æ –≤–∏—è–≤–ª–µ–Ω–Ω—è –æ–±'—î–∫—Ç—ñ–≤.</li>
            </ul>
        </div>
    </details>

    <script>
        // DOM –ï–ª–µ–º–µ–Ω—Ç–∏
        const log = document.getElementById('log');
        const btnReset = document.getElementById('btnReset');
        const btnStart = document.getElementById('btnStart');
        const btnStepForward = document.getElementById('btnStepForward');
        const btnStepBack = document.getElementById('btnStepBack');
        const btnGenerate = document.getElementById('btnGenerate');
        const numNodesInput = document.getElementById('numNodes');

        // –°—Ç–∞–Ω —Å–∏–º—É–ª—è—Ü—ñ—ó
        let cy; // –ï–∫–∑–µ–º–ø–ª—è—Ä Cytoscape
        let nodes = []; // { id: 'A' }
        let edges = []; // { u: 0, v: 1, weight: 10, id: 'e0' }
        let sortedEdges = [];
        let stepIndex = 0;
        let totalNodes = 0;

        // Union-Find
        let parent = [];
        let rank = [];
        let mstEdgesCount = 0;

        function find(i) {
            if (parent[i] !== i) {
                parent[i] = find(parent[i]);
            }
            return parent[i];
        }

        function union(x, y) {
            const xroot = find(x);
            const yroot = find(y);
            if (rank[xroot] < rank[yroot]) {
                parent[xroot] = yroot;
            } else if (rank[xroot] > rank[yroot]) {
                parent[yroot] = xroot;
            } else {
                parent[yroot] = xroot;
                rank[xroot]++;
            }
        }

        function resetUnionFind() {
            parent = Array(totalNodes).fill(0).map((_, i) => i);
            rank = Array(totalNodes).fill(0);
            mstEdgesCount = 0;
        }

        // –õ–æ–≥—É–≤–∞–Ω–Ω—è
        function logMessage(message, color = 'black') {
            log.innerHTML += `<span style="color: ${color};">${message}</span><br>`;
            log.scrollTop = log.scrollHeight;
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –≥—Ä–∞—Ñ–∞
        function generateRandomGraph() {
            const n = parseInt(numNodesInput.value);
            if (n < 3 || n > 20) {
                alert('–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≤–µ—Ä—à–∏–Ω –ø–æ–≤–∏–Ω–Ω–∞ –±—É—Ç–∏ –≤—ñ–¥ 3 –¥–æ 20.');
                return;
            }
            totalNodes = n;
            nodes = [];
            for (let i = 0; i < n; i++) {
                nodes.push({ id: String.fromCharCode(65 + i) });
            }
            
            edges = [];
            let edgeCounter = 0;
            for (let i = 0; i < n; i++) {
                for (let j = i + 1; j < n; j++) {
                    if (Math.random() > 0.3) {
                        edges.push({
                            u: i,
                            v: j,
                            weight: Math.floor(Math.random() * 20) + 1,
                            id: `e${edgeCounter++}`
                        });
                    }
                }
            }
            
            initCytoscape();
            resetGraph();
        }

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Cytoscape
        function initCytoscape() {
            const cyElements = [];
            nodes.forEach(node => {
                cyElements.push({ 
                    data: { id: node.id, label: node.id } 
                });
            });
            edges.forEach(edge => {
                cyElements.push({
                    data: {
                        id: edge.id,
                        source: nodes[edge.u].id,
                        target: nodes[edge.v].id,
                        weight: edge.weight,
                        label: edge.weight.toString()
                    }
                });
            });

            if (cy) {
                cy.destroy();
            }

            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: cyElements,
                style: [
                    {
                        selector: 'node',
                        style: {
                            'background-color': '#666',
                            'label': 'data(label)',
                            'width': 30,
                            'height': 30,
                            'font-size': '16px',
                            'color': '#000',
                            'text-valign': 'center',
                            'text-halign': 'center'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 3,
                            'line-color': '#ccc',
                            'label': 'data(label)',
                            'font-size': '14px',
                            'color': '#333',
                            'text-background-opacity': 1,
                            'text-background-color': '#fff',
                            'text-background-padding': '3px',
                            'curve-style': 'bezier'
                        }
                    },
                    {
                        selector: '.highlighted',
                        style: {
                            'line-color': '#007bff',
                            'width': 5,
                            'z-index': 10
                        }
                    },
                    {
                        selector: '.mst',
                        style: {
                            'line-color': '#28a745',
                            'width': 6,
                            'z-index': 5
                        }
                    },
                    {
                        selector: '.rejected',
                        style: {
                            'line-color': '#dc3545',
                            'line-style': 'dashed',
                            'opacity': 0.6
                        }
                    }
                ],
                layout: {
                    name: 'cose',
                    idealEdgeLength: (el) => 100,
                    nodeOverlap: 20,
                    refresh: 20,
                    fit: true,
                    padding: 30,
                    randomize: false,
                    componentSpacing: 100,
                    nodeRepulsion: (node) => 400000,
                    edgeElasticity: (edge) => 100,
                    nestingFactor: 5,
                    gravity: 80,
                    numIter: 1000,
                    initialTemp: 200,
                    coolingFactor: 0.95,
                    minTemp: 1.0
                }
            });
            
            cy.on('tap', 'edge', function(evt) {
                const edge = evt.target;
                const oldWeight = edge.data('weight');
                const newWeightStr = prompt('–ù–æ–≤–∞ –≤–∞–≥–∞:', oldWeight);
                
                if (newWeightStr !== null) {
                    const newWeight = parseInt(newWeightStr);
                    if (!isNaN(newWeight) && newWeight > 0) {
                        edge.data('weight', newWeight);
                        edge.data('label', newWeight.toString());
                        
                        const originalEdge = edges.find(e => e.id === edge.data('id'));
                        if (originalEdge) {
                            originalEdge.weight = newWeight;
                        }
                        
                        resetGraph();
                        logMessage(`–í–∞–≥—É —Ä–µ–±—Ä–∞ ${edge.data('source')}-${edge.data('target')} –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞ ${newWeight}.`);
                    } else {
                        alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–µ –¥–æ–¥–∞—Ç–Ω–µ —á–∏—Å–ª–æ.');
                    }
                }
            });
        }
        
        // –ö–µ—Ä—É–≤–∞–Ω–Ω—è —Å–∏–º—É–ª—è—Ü—ñ—î—é
        function resetGraph() {
            sortedEdges = [...edges].sort((a, b) => a.weight - b.weight);
            stepIndex = 0;
            log.innerHTML = '';
            resetUnionFind();
            
            if (cy) {
                cy.edges().removeClass('mst highlighted rejected');
                cy.nodes().style('background-color', '#666');
            }
            
            updateButtonStates();
            logMessage('–ì—Ä–∞—Ñ —Å–∫–∏–Ω—É—Ç–æ. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –ê–ª–≥–æ—Ä–∏—Ç–º" –∞–±–æ "–ö—Ä–æ–∫ –í–ø–µ—Ä–µ–¥".');
        }
        
        function performStepSilent(i) {
            if (i >= sortedEdges.length) return;
            const edge = sortedEdges[i];
            const cyEdge = cy.getElementById(edge.id);
            
            const x = find(edge.u);
            const y = find(edge.v);
            
            if (x !== y) {
                mstEdgesCount++;
                union(edge.u, edge.v);
                cyEdge.addClass('mst');
            } else {
                cyEdge.addClass('rejected');
            }
        }
        
        function performStepForward() {
            cy.edges().removeClass('highlighted rejected');
            
            const edge = sortedEdges[stepIndex];
            const cyEdge = cy.getElementById(edge.id);
            const uLabel = nodes[edge.u].id;
            const vLabel = nodes[edge.v].id;
            
            logMessage(`<b>–ö—Ä–æ–∫ ${stepIndex + 1}:</b> –†–æ–∑–≥–ª—è–¥–∞—î–º–æ ${uLabel}-${vLabel} (–≤–∞–≥–∞: ${edge.weight})`);
            cyEdge.addClass('highlighted');
            
            const x = find(edge.u);
            const y = find(edge.v);
            
            if (x !== y) {
                mstEdgesCount++;
                union(edge.u, edge.v);
                cyEdge.addClass('mst');
                cy.getElementById(uLabel).style('background-color', '#28a745');
                cy.getElementById(vLabel).style('background-color', '#28a745');
                logMessage(`-> –î–æ–¥–∞–Ω–æ –¥–æ MST. (–†–µ–±–µ—Ä: ${mstEdgesCount})`, 'green');
            } else {
                cyEdge.addClass('rejected');
                logMessage(`-> –í—ñ–¥—Ö–∏–ª–µ–Ω–æ (—Ü–∏–∫–ª).`, 'red');
            }
        }
        
        function stepForward() {
            if (stepIndex >= sortedEdges.length) {
                logMessage('<b>–ê–ª–≥–æ—Ä–∏—Ç–º –∑–∞–≤–µ—Ä—à–µ–Ω–æ.</b>', 'blue');
                updateButtonStates();
                return;
            }
            
            performStepForward();
            stepIndex++;
            
            if (mstEdgesCount === totalNodes - 1) {
                logMessage(`<b>MST –ø–æ–±—É–¥–æ–≤–∞–Ω–æ! (–ú—ñ—Å—Ç–∏—Ç—å ${mstEdgesCount} —Ä–µ–±–µ—Ä)</b>`, 'blue');
                stepIndex = sortedEdges.length;
            }
            updateButtonStates();
        }

        function stepBack() {
            if (stepIndex <= 0) {
                logMessage('–ù–µ–º–∞—î –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö –∫—Ä–æ–∫—ñ–≤.');
                return;
            }
            stepIndex--;
            
            resetUnionFind();
            cy.edges().removeClass('mst highlighted rejected');
            cy.nodes().style('background-color', '#666');
            
            for (let i = 0; i < stepIndex; i++) {
                performStepSilent(i);
            }
            
            cy.edges('.mst').forEach(edge => {
                edge.source().style('background-color', '#28a745');
                edge.target().style('background-color', '#28a745');
            });

            if (stepIndex < sortedEdges.length) {
                 cy.getElementById(sortedEdges[stepIndex].id).addClass('highlighted');
            }

            log.innerHTML = '';
            logMessage(`–ö—Ä–æ–∫ –Ω–∞–∑–∞–¥ –¥–æ –∫—Ä–æ–∫—É ${stepIndex + 1}.`);
            updateButtonStates();
        }

        let animationInterval = null;
        function startKruskal() {
            resetGraph();
            // –í–∏–º–∏–∫–∞—î–º–æ –∫–Ω–æ–ø–∫–∏ –ø—ñ–¥ —á–∞—Å –∞–Ω—ñ–º–∞—Ü—ñ—ó
            setControlsDisabled(true);
            
            animationInterval = setInterval(() => {
                if (stepIndex >= sortedEdges.length || mstEdgesCount === totalNodes - 1) {
                    clearInterval(animationInterval);
                    animationInterval = null;
                    if (mstEdgesCount !== totalNodes - 1) {
                         logMessage('<b>–ê–ª–≥–æ—Ä–∏—Ç–º –∑–∞–≤–µ—Ä—à–µ–Ω–æ (–ø—Ä–æ–π–¥–µ–Ω–æ –≤—Å—ñ —Ä–µ–±—Ä–∞).</b>', 'blue');
                    }
                    setControlsDisabled(false); // –í–º–∏–∫–∞—î–º–æ –∫–Ω–æ–ø–∫–∏
                    updateButtonStates(); // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω –∫–Ω–æ–ø–æ–∫
                    return;
                }
                stepForward();
            }, 800);
        }
        
        function stopKruskal() {
            if (animationInterval) {
                clearInterval(animationInterval);
                animationInterval = null;
            }
            setControlsDisabled(false);
            updateButtonStates();
            logMessage('<b>–ê–Ω—ñ–º–∞—Ü—ñ—é –∑—É–ø–∏–Ω–µ–Ω–æ.</b>', 'orange');
        }

        function setControlsDisabled(disabled) {
            btnStart.disabled = disabled;
            btnStepForward.disabled = disabled;
            btnStepBack.disabled = disabled;
            btnGenerate.disabled = disabled;
            // –ö–Ω–æ–ø–∫–∞ Reset/Stop –º–∞—î –æ—Å–æ–±–ª–∏–≤—É –ª–æ–≥—ñ–∫—É
            btnReset.disabled = false; 
        }

        function updateButtonStates() {
            const isRunning = animationInterval !== null;
            if (isRunning) return; // –ù–µ –æ–Ω–æ–≤–ª—é—î–º–æ, —è–∫—â–æ –∞–Ω—ñ–º–∞—Ü—ñ—è –∑–∞–ø—É—â–µ–Ω–∞

            btnStepForward.disabled = (stepIndex >= sortedEdges.length || mstEdgesCount === totalNodes - 1);
            btnStepBack.disabled = (stepIndex <= 0);
            btnStart.disabled = false;
            btnGenerate.disabled = false;
        }

        // –ü—Ä–∏–≤'—è–∑–∫–∞ –ø–æ–¥—ñ–π –¥–æ –∫–Ω–æ–ø–æ–∫
        btnGenerate.addEventListener('click', generateRandomGraph);
        
        btnReset.addEventListener('click', () => {
            if (animationInterval) {
                stopKruskal(); // –Ø–∫—â–æ –∞–Ω—ñ–º–∞—Ü—ñ—è –∑–∞–ø—É—â–µ–Ω–∞, –∫–Ω–æ–ø–∫–∞ –ø—Ä–∞—Ü—é—î —è–∫ "Stop"
            } else {
                resetGraph(); // –Ü–Ω–∞–∫—à–µ, –≤–æ–Ω–∞ —Å–∫–∏–¥–∞—î –≥—Ä–∞—Ñ
            }
        });
        
        btnStart.addEventListener('click', startKruskal);
        btnStepForward.addEventListener('click', stepForward);
        btnStepBack.addEventListener('click', stepBack);

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
        generateRandomGraph();
    </script>
</body>
</html>